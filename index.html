<!DOCTYPE html>
<html lang="th" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Prompt', sans-serif; }
    
    /* Animation Utility Classes */
    .stat-card {
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(0,0,0,0.1);
    }
    
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideInLeft {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    .fade-in { animation: fadeInUp 0.5s ease-out forwards; }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    .login-input:focus { box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
    .nav-item { transition: all 0.2s ease; }
    .nav-item.active {
      background: rgba(255, 255, 255, 0.15);
      border-left: 4px solid #fff;
    }
    .form-input { transition: all 0.2s ease; }
    .form-input:focus { 
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); 
    }
    
    /* Modal Transition */
    .modal-enter { opacity: 0; transform: scale(0.95); }
    .modal-enter-active { opacity: 1; transform: scale(1); transition: all 0.2s ease-out; }
    .modal-exit { opacity: 1; transform: scale(1); }
    .modal-exit-active { opacity: 0; transform: scale(0.95); transition: all 0.2s ease-in; }

    /* Sidebar Transition */
    #main-sidebar {
        transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .sidebar-text {
        transition: opacity 0.2s ease, width 0.2s ease;
        white-space: nowrap;
        overflow: hidden;
    }
    .sidebar-collapsed .sidebar-text {
        opacity: 0;
        width: 0;
        display: none; /* Helps with layout shift */
    }
    .sidebar-collapsed .nav-item {
        justify-content: center;
        padding-left: 0;
        padding-right: 0;
    }
    .sidebar-collapsed #sidebar-header {
        justify-content: center;
        padding-left: 0;
        padding-right: 0;
    }
    .sidebar-collapsed #user-profile-container {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
        justify-content: center;
    }

    /* AI Loading Animation */
    .typing-indicator span {
      display: inline-block;
      width: 6px;
      height: 6px;
      background-color: #6366f1;
      border-radius: 50%;
      animation: typing 1.4s infinite ease-in-out both;
      margin: 0 2px;
    }
    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes typing {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    /* AI Card Transitions */
    .ai-card-content {
        transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out;
        max-height: 5000px;
        opacity: 1;
        overflow: hidden;
    }
    .ai-card-collapsed .ai-card-content {
        max-height: 0;
        opacity: 0;
        padding-top: 0;
        padding-bottom: 0;
        border-top: none;
    }
    .ai-arrow {
        transition: transform 0.3s ease;
    }
    .ai-card-collapsed .ai-arrow {
        transform: rotate(-90deg);
    }

    /* Force 24h look on Webkit Time Inputs */
    input[type="time"]::-webkit-datetime-edit-ampm-field {
        display: none;
    }
  </style>
</head>
<body class="h-full bg-slate-50 overflow-hidden text-slate-800">
  <div id="app" class="w-full h-full flex flex-col">
    
    <!-- ================= LOGIN PAGE ================= -->
    <div id="login-page" class="w-full h-full flex items-center justify-center px-4 bg-gradient-to-br from-indigo-600 via-purple-600 to-indigo-800">
      <div class="max-w-md w-full animate-[slideInLeft_0.5s_ease-out]">
        <!-- Logo -->
        <div class="text-center mb-8">
          <div class="inline-flex items-center justify-center w-24 h-24 bg-white/20 rounded-2xl backdrop-blur-xl mb-6 border border-white/30 shadow-xl overflow-hidden p-2">
            <!-- ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà src="" -->
            <img src="https://placehold.co/200x200/white/indigo?text=SCHOOL+LOGO" alt="Logo" class="w-full h-full object-contain">
          </div>
          <h1 class="text-3xl font-bold text-white mb-1 drop-shadow-md">‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏π‡πÅ‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
          <p class="text-indigo-100 text-sm font-light">Student Behavior Management System</p>
        </div>

        <!-- Form -->
        <div class="bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl p-8 border border-white/50">
          <form onsubmit="handleLogin(event)">
            <div class="mb-5">
              <label class="block text-sm font-semibold text-slate-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label>
              <input type="text" id="username" value="admin" class="login-input w-full px-4 py-3 border border-slate-200 rounded-xl focus:outline-none transition-colors bg-slate-50 focus:bg-white" placeholder="Username">
            </div>
            <div class="mb-6">
              <label class="block text-sm font-semibold text-slate-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
              <input type="password" id="password" value="1234" class="login-input w-full px-4 py-3 border border-slate-200 rounded-xl focus:outline-none transition-colors bg-slate-50 focus:bg-white" placeholder="Password">
            </div>

            <div id="login-error" class="hidden mb-4 p-3 bg-rose-50 border border-rose-200 text-rose-600 text-sm rounded-lg flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            </div>

            <button type="submit" class="w-full py-3.5 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-xl shadow-lg shadow-indigo-200 transition-all active:scale-95">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
          </form>
          
          <div class="mt-6 text-center">
            <p class="text-xs text-slate-400">Demo: admin / 1234 (‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≠‡∏á teacher1 / 1234)</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ================= DASHBOARD LAYOUT ================= -->
    <div id="dashboard-layout" class="hidden w-full h-full flex bg-slate-50">
      
      <!-- Sidebar -->
      <aside id="main-sidebar" class="w-72 bg-slate-900 text-slate-300 flex flex-col shadow-2xl z-20">
        <!-- Sidebar Header -->
        <div id="sidebar-header" class="p-4 border-b border-slate-800 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center shadow-lg shadow-indigo-500/30 flex-shrink-0 overflow-hidden">
                    <!-- ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà src="" -->
                    <img src="https://placehold.co/100x100/indigo/white?text=LOGO" alt="Logo" class="w-full h-full object-cover">
                </div>
                <div class="sidebar-text overflow-hidden">
                    <h2 class="text-white font-bold text-lg leading-tight truncate">StudentCare</h2>
                    <p class="text-xs text-slate-500 truncate">System v1.0</p>
                </div>
            </div>
            <!-- Toggle Button -->
            <button onclick="toggleSidebar()" class="text-slate-500 hover:text-white p-1 rounded transition-colors sidebar-text">
                <svg id="sidebar-toggle-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path></svg>
            </button>
        </div>

        <!-- User Profile -->
        <div id="user-profile-container" class="p-4 mx-4 mt-6 bg-slate-800/50 rounded-xl border border-slate-700 flex items-center gap-3 transition-all duration-300">
             <div id="user-avatar" class="w-10 h-10 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-500 flex items-center justify-center text-white font-bold text-sm flex-shrink-0">
                 AD
             </div>
             <div class="sidebar-text overflow-hidden">
                 <p id="display-name" class="text-white text-sm font-medium truncate">Admin Teacher</p>
                 <p id="display-role" class="text-xs text-slate-500 truncate">‡∏ù‡πà‡∏≤‡∏¢‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</p>
             </div>
        </div>

        <!-- Menu -->
        <nav class="flex-1 px-4 py-6 space-y-1 overflow-y-auto">
          <p class="px-4 text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 sidebar-text">‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</p>
          
          <button onclick="switchPage('dashboard')" id="nav-dashboard" class="nav-item active w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left text-sm font-medium hover:text-white hover:bg-slate-800/50" title="‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°">
            <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
            <span class="sidebar-text">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° (Dashboard)</span>
          </button>
          
          <button onclick="switchPage('record')" id="nav-record" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left text-sm font-medium hover:text-white hover:bg-slate-800/50" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ñ‡∏™‡πÉ‡∏´‡∏°‡πà">
            <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
            <span class="sidebar-text">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ñ‡∏™‡πÉ‡∏´‡∏°‡πà</span>
          </button>
          
          <button onclick="switchPage('cases')" id="nav-cases" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left text-sm font-medium hover:text-white hover:bg-slate-800/50" title="‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥/‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏™">
            <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
            <span class="sidebar-text">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥/‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏™</span>
          </button>

          <!-- Admin Menu (Hidden by default) -->
          <div id="admin-menu-section" class="hidden pt-6">
              <p class="px-4 text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 sidebar-text">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</p>
              <button onclick="switchPage('admin')" id="nav-admin" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left text-sm font-medium text-amber-400 hover:text-amber-300 hover:bg-slate-800/50" title="‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô">
                <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                <span class="sidebar-text">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
              </button>
          </div>
        </nav>

        <!-- Logout -->
        <div class="p-4 border-t border-slate-800">
          <button onclick="handleLogout()" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left text-sm font-medium text-rose-400 hover:bg-rose-950/30 hover:text-rose-300 transition-colors" title="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö">
            <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
            <span class="sidebar-text">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
          </button>
        </div>
        
        <!-- Bottom Toggle (Alternative for easier click) -->
        <div class="p-2 flex justify-center border-t border-slate-800">
             <button onclick="toggleSidebar()" class="text-slate-500 hover:text-white p-1">
                 <svg id="sidebar-toggle-icon-bottom" class="w-6 h-6 transform rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path></svg>
             </button>
        </div>
      </aside>

      <!-- Main Content Area -->
      <div class="flex-1 flex flex-col h-full overflow-hidden relative">
        <!-- Topbar -->
        <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 shadow-sm z-10">
          <h2 id="page-title" class="text-xl font-bold text-slate-800">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h2>
          <div class="flex items-center gap-4">
              <div class="text-right hidden sm:block">
                  <!-- Realtime Date & Time -->
                  <p class="text-sm font-bold text-indigo-600 mt-0.5" id="realtime-clock">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
                  <p class="text-xs text-slate-500 font-medium text-right" id="academic-info">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
              </div>
          </div>
        </header>

        <!-- Scrollable Content -->
        <main class="flex-1 overflow-auto bg-slate-50 p-8">
            
            <!-- VIEW: DASHBOARD -->
            <div id="view-dashboard" class="space-y-6 animate-[fadeInUp_0.4s_ease-out]">
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between stat-card group">
                        <div>
                            <p class="text-sm font-medium text-slate-500 mb-1">‡πÄ‡∏Ñ‡∏™‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                            <h3 class="text-3xl font-bold text-slate-800 group-hover:text-indigo-600 transition-colors" id="stat-total">0</h3>
                        </div>
                        <div class="w-12 h-12 bg-indigo-50 rounded-xl flex items-center justify-center text-indigo-600 group-hover:bg-indigo-600 group-hover:text-white transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between stat-card group">
                        <div>
                            <p class="text-sm font-medium text-slate-500 mb-1">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>
                            <h3 class="text-3xl font-bold text-amber-500" id="stat-pending">0</h3>
                        </div>
                        <div class="w-12 h-12 bg-amber-50 rounded-xl flex items-center justify-center text-amber-500 group-hover:bg-amber-500 group-hover:text-white transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between stat-card group">
                        <div>
                            <p class="text-sm font-medium text-slate-500 mb-1">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß</p>
                            <h3 class="text-3xl font-bold text-emerald-600" id="stat-resolved">0</h3>
                        </div>
                        <div class="w-12 h-12 bg-emerald-50 rounded-xl flex items-center justify-center text-emerald-600 group-hover:bg-emerald-600 group-hover:text-white transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                        </div>
                    </div>
                </div>

                <!-- Graphs Area -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <h3 class="font-bold text-slate-800 mb-4">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°</h3>
                        <div id="chart-behavior" class="space-y-4">
                            <!-- JS Generated Bars -->
                            <div class="text-center text-slate-400 py-8">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <h3 class="font-bold text-slate-800 mb-4">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</h3>
                        <div id="chart-grade" class="space-y-4">
                            <!-- JS Generated Bars -->
                            <div class="text-center text-slate-400 py-8">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: RECORD FORM -->
            <div id="view-record" class="hidden max-w-4xl mx-auto animate-[fadeInUp_0.4s_ease-out]">
                <div class="bg-white rounded-2xl shadow-lg border border-slate-100 overflow-hidden">
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 px-8 py-6">
                        <h2 class="text-xl font-bold text-white flex items-center gap-2">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°
                        </h2>
                        <p class="text-indigo-100 text-sm mt-1">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</p>
                    </div>
                    
                    <form id="record-form" onsubmit="handleRecordSubmit(event)" class="p-8 space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏</label>
                                <input type="date" id="input-date" required class="form-input w-full px-4 py-2.5 border border-slate-200 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á : ‡∏ô‡∏≤‡∏ó‡∏µ)</label>
                                <!-- Custom 24h Time Picker -->
                                <div class="flex gap-2">
                                    <select id="input-time-hour" class="form-input w-1/2 px-4 py-2.5 border border-slate-200 rounded-lg appearance-none bg-white text-center">
                                        <!-- JS Generated -->
                                    </select>
                                    <span class="self-center font-bold text-slate-400">:</span>
                                    <select id="input-time-minute" class="form-input w-1/2 px-4 py-2.5 border border-slate-200 rounded-lg appearance-none bg-white text-center">
                                        <!-- JS Generated -->
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Student Section (Multi-select) -->
                        <div class="p-5 bg-slate-50 rounded-xl border border-slate-200 space-y-4">
                            <div class="flex justify-between items-center">
                                <h4 class="text-sm font-bold text-indigo-600 uppercase tracking-wide">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢)</h4>
                                <button type="button" onclick="addStudentRow()" class="text-sm bg-white border border-indigo-200 text-indigo-600 px-3 py-1.5 rounded-lg hover:bg-indigo-50 transition-colors flex items-center gap-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                                </button>
                            </div>
                            
                            <div id="student-container" class="space-y-3">
                                <!-- Student rows will be injected here -->
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°</label>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <label class="cursor-pointer">
                                    <input type="radio" name="behavior" value="fight" class="peer sr-only" onchange="toggleViceOptions()" required>
                                    <div class="p-3 text-center border border-slate-200 rounded-lg peer-checked:bg-rose-50 peer-checked:border-rose-500 peer-checked:text-rose-700 hover:bg-slate-50 transition-all">
                                        <div class="text-xl mb-1">‚öîÔ∏è</div>
                                        <div class="text-xs font-medium">‡∏ó‡∏∞‡πÄ‡∏•‡∏≤‡∏∞‡∏ß‡∏¥‡∏ß‡∏≤‡∏ó</div>
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="behavior" value="skip" class="peer sr-only" onchange="toggleViceOptions()">
                                    <div class="p-3 text-center border border-slate-200 rounded-lg peer-checked:bg-amber-50 peer-checked:border-amber-500 peer-checked:text-amber-700 hover:bg-slate-50 transition-all">
                                        <div class="text-xl mb-1">üèÉ</div>
                                        <div class="text-xs font-medium">‡∏´‡∏ô‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="behavior" value="vice" class="peer sr-only" onchange="toggleViceOptions()">
                                    <div class="p-3 text-center border border-slate-200 rounded-lg peer-checked:bg-slate-100 peer-checked:border-slate-500 peer-checked:text-slate-700 hover:bg-slate-50 transition-all">
                                        <div class="text-xl mb-1">üö¨</div>
                                        <div class="text-xs font-medium">‡∏≠‡∏ö‡∏≤‡∏¢‡∏°‡∏∏‡∏Ç</div>
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="behavior" value="relationship" class="peer sr-only" onchange="toggleViceOptions()">
                                    <div class="p-3 text-center border border-slate-200 rounded-lg peer-checked:bg-pink-50 peer-checked:border-pink-500 peer-checked:text-pink-700 hover:bg-slate-50 transition-all">
                                        <div class="text-xl mb-1">üíï</div>
                                        <div class="text-xs font-medium">‡∏ä‡∏π‡πâ‡∏™‡∏≤‡∏ß</div>
                                    </div>
                                </label>
                            </div>

                            <!-- Sub-category for Vice -->
                            <div id="vice-sub-options" class="hidden mt-4 p-4 bg-slate-100 rounded-lg border border-slate-200 animate-[fadeInUp_0.2s_ease-out]">
                                <label class="block text-xs font-bold text-slate-600 mb-2">‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏ö‡∏≤‡∏¢‡∏°‡∏∏‡∏Ç:</label>
                                <select id="input-vice-type" class="form-input w-full px-4 py-2 border border-slate-300 rounded-lg text-sm bg-white">
                                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó --</option>
                                    <option value="‡∏™‡∏∏‡∏£‡∏≤">‡∏™‡∏∏‡∏£‡∏≤</option>
                                    <option value="‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà">‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà</option>
                                    <option value="‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà‡πÑ‡∏ü‡∏ü‡πâ‡∏≤">‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</option>
                                    <option value="‡∏Å‡∏±‡∏ç‡∏ä‡∏≤">‡∏Å‡∏±‡∏ç‡∏ä‡∏≤</option>
                                    <option value="‡∏¢‡∏≤‡∏ö‡πâ‡∏≤">‡∏¢‡∏≤‡∏ö‡πâ‡∏≤</option>
                                    <option value="‡∏¢‡∏≤‡πÇ‡∏õ‡∏£">‡∏¢‡∏≤‡πÇ‡∏õ‡∏£ (‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß/‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á)</option>
                                    <option value="‡∏ô‡πâ‡∏≥‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°">‡∏ô‡πâ‡∏≥‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                            <textarea id="input-detail" rows="4" class="form-input w-full px-4 py-3 border border-slate-200 rounded-lg resize-none" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á..."></textarea>
                        </div>

                        <div class="flex items-center gap-4 pt-4 border-t border-slate-100">
                            <button type="button" onclick="resetForm()" class="px-6 py-2.5 text-slate-600 bg-slate-100 hover:bg-slate-200 font-medium rounded-lg transition-colors">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
                            <button type="submit" class="flex-1 px-6 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg shadow-lg shadow-indigo-200 transition-all active:scale-95">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- VIEW: CASES LIST -->
            <div id="view-cases" class="hidden animate-[fadeInUp_0.4s_ease-out]">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="p-6 border-b border-slate-100 flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <h3 class="font-bold text-slate-800 text-lg">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h3>
                        <div class="flex gap-2">
                            <select id="filter-grade" onchange="renderTable()" class="text-sm border border-slate-200 rounded-lg px-3 py-2 bg-slate-50">
                                <option value="all">‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</option>
                                <option value="‡∏°.1">‡∏°.1</option>
                                <option value="‡∏°.2">‡∏°.2</option>
                                <option value="‡∏°.3">‡∏°.3</option>
                                <option value="‡∏°.4">‡∏°.4</option>
                                <option value="‡∏°.5">‡∏°.5</option>
                                <option value="‡∏°.6">‡∏°.6</option>
                            </select>
                            <select id="filter-status" onchange="renderTable()" class="text-sm border border-slate-200 rounded-lg px-3 py-2 bg-slate-50">
                                <option value="all">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                <option value="pending">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                                <option value="resolved">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß</option>
                            </select>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-slate-50 border-b border-slate-200 text-xs uppercase text-slate-500 font-semibold tracking-wider">
                                    <th class="px-6 py-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                    <th class="px-6 py-4">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                    <th class="px-6 py-4">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</th>
                                    <th class="px-6 py-4">‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°</th>
                                    <th class="px-6 py-4">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th class="px-6 py-4 text-right">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="cases-tbody" class="text-sm divide-y divide-slate-100">
                                <!-- JS Generated Rows -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- VIEW: ADMIN MONITOR -->
            <div id="view-admin" class="hidden space-y-6 animate-[fadeInUp_0.4s_ease-out]">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                        <h3 class="font-bold text-slate-800 text-lg flex items-center gap-2">
                            <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                            ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (Active Sessions)
                        </h3>
                    </div>
                    <div class="p-6">
                         <div id="active-sessions-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="p-6 border-b border-slate-100">
                        <h3 class="font-bold text-slate-800 text-lg">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Login Logs)</h3>
                    </div>
                    <div class="overflow-x-auto max-h-[500px]">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-50 sticky top-0">
                                <tr class="text-xs uppercase text-slate-500 font-semibold tracking-wider border-b border-slate-200">
                                    <th class="px-6 py-3">‡πÄ‡∏ß‡∏•‡∏≤</th>
                                    <th class="px-6 py-3">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</th>
                                    <th class="px-6 py-3">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</th>
                                    <th class="px-6 py-3">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th>
                                </tr>
                            </thead>
                            <tbody id="logs-tbody" class="text-sm divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </main>
      </div>

    </div>
  </div>

  <!-- MODAL: EDIT CASE -->
  <div id="modal-backdrop" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
      <div id="modal-content" class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl transform scale-95 opacity-0 transition-all duration-200 flex flex-col max-h-[90vh]">
          <!-- Header -->
          <div class="p-6 border-b border-slate-100 bg-slate-50 rounded-t-2xl flex justify-between items-center">
              <div>
                  <h3 class="text-lg font-bold text-slate-800">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏Ñ‡∏™</h3>
                  <p class="text-xs text-slate-500 mt-1">‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</p>
              </div>
              <button onclick="closeModalWithCheck()" class="p-2 hover:bg-slate-200 rounded-full transition-colors text-slate-500">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
              </button>
          </div>
          
          <!-- Scrollable Body -->
          <div class="p-6 overflow-y-auto">
              <form id="edit-form" class="space-y-6">
                  <div class="grid grid-cols-2 gap-4">
                      <div>
                          <label class="block text-xs font-bold text-slate-500 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                          <input type="date" id="edit-date" class="form-input w-full px-3 py-2 border border-slate-200 rounded-lg text-sm">
                      </div>
                      <div>
                          <label class="block text-xs font-bold text-slate-500 mb-1">‡πÄ‡∏ß‡∏•‡∏≤ (24 ‡∏ä‡∏°.)</label>
                          <!-- Custom 24h Time Picker -->
                          <div class="flex gap-2">
                              <select id="edit-time-hour" class="form-input w-1/2 px-3 py-2 border border-slate-200 rounded-lg text-sm bg-white text-center">
                                  <!-- JS Generated -->
                              </select>
                              <span class="self-center font-bold text-slate-400">:</span>
                              <select id="edit-time-minute" class="form-input w-1/2 px-3 py-2 border border-slate-200 rounded-lg text-sm bg-white text-center">
                                  <!-- JS Generated -->
                              </select>
                          </div>
                      </div>
                  </div>
                  
                  <!-- Edit Students Container -->
                  <div class="p-4 bg-slate-50 rounded-lg border border-slate-200">
                      <div class="flex justify-between items-center mb-3">
                          <label class="block text-xs font-bold text-slate-600 uppercase">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                          <button type="button" onclick="addStudentRow('edit-student-container')" class="text-xs text-indigo-600 hover:bg-indigo-50 px-2 py-1 rounded border border-indigo-200">
                              + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ô
                          </button>
                      </div>
                      <div id="edit-student-container" class="space-y-3">
                          <!-- Dynamic rows -->
                      </div>
                  </div>

                  <div>
                      <label class="block text-xs font-bold text-slate-500 mb-1">‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°</label>
                      <select id="edit-behavior" onchange="toggleViceOptionsEdit()" class="form-input w-full px-3 py-2 border border-slate-200 rounded-lg text-sm bg-white">
                          <option value="fight">‡∏ó‡∏∞‡πÄ‡∏•‡∏≤‡∏∞‡∏ß‡∏¥‡∏ß‡∏≤‡∏ó</option>
                          <option value="skip">‡∏´‡∏ô‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                          <option value="vice">‡∏≠‡∏ö‡∏≤‡∏¢‡∏°‡∏∏‡∏Ç</option>
                          <option value="relationship">‡∏ä‡∏π‡πâ‡∏™‡∏≤‡∏ß</option>
                      </select>
                  </div>

                  <div id="edit-vice-sub-options" class="hidden p-3 bg-slate-100 rounded-lg border border-slate-200">
                        <label class="block text-xs font-bold text-slate-600 mb-1">‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏ö‡∏≤‡∏¢‡∏°‡∏∏‡∏Ç:</label>
                        <select id="edit-vice-type" class="form-input w-full px-3 py-2 border border-slate-300 rounded-lg text-sm bg-white">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó --</option>
                            <option value="‡∏™‡∏∏‡∏£‡∏≤">‡∏™‡∏∏‡∏£‡∏≤</option>
                            <option value="‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà">‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà</option>
                            <option value="‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà‡πÑ‡∏ü‡∏ü‡πâ‡∏≤">‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</option>
                            <option value="‡∏Å‡∏±‡∏ç‡∏ä‡∏≤">‡∏Å‡∏±‡∏ç‡∏ä‡∏≤</option>
                            <option value="‡∏¢‡∏≤‡∏ö‡πâ‡∏≤">‡∏¢‡∏≤‡∏ö‡πâ‡∏≤</option>
                            <option value="‡∏¢‡∏≤‡πÇ‡∏õ‡∏£">‡∏¢‡∏≤‡πÇ‡∏õ‡∏£ (‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß/‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á)</option>
                            <option value="‡∏ô‡πâ‡∏≥‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°">‡∏ô‡πâ‡∏≥‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°</option>
                        </select>
                  </div>

                  <div>
                      <label class="block text-xs font-bold text-slate-500 mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                      <textarea id="edit-detail" rows="4" class="form-input w-full px-3 py-2 border border-slate-200 rounded-lg text-sm resize-none"></textarea>
                  </div>
                  
                  <!-- AI Assistant Section -->
                  <div class="p-4 bg-indigo-50 rounded-lg border border-indigo-100">
                      <h4 class="text-sm font-bold text-indigo-700 mb-2 flex items-center gap-2">
                          <span>ü§ñ AI Assistant (‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞)</span>
                      </h4>
                      
                      <div class="flex gap-2 mb-3">
                          <button type="button" onclick="generateAIAdvice()" class="flex-1 text-xs bg-white border border-indigo-200 text-indigo-600 hover:bg-indigo-50 py-2 px-3 rounded-lg shadow-sm transition-colors flex items-center justify-center gap-1">
                              ‚ú® ‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤
                          </button>
                          <button type="button" onclick="generateAILetter()" class="flex-1 text-xs bg-white border border-indigo-200 text-indigo-600 hover:bg-indigo-50 py-2 px-3 rounded-lg shadow-sm transition-colors flex items-center justify-center gap-1">
                              ‚ú® ‡∏£‡πà‡∏≤‡∏á‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏ä‡∏¥‡∏ç‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á
                          </button>
                      </div>

                      <div id="ai-loading" class="hidden text-center py-4">
                          <div class="typing-indicator">
                              <span></span><span></span><span></span>
                          </div>
                          <p class="text-xs text-indigo-400 mt-2">AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
                      </div>

                      <!-- New Container for AI Responses -->
                      <div id="ai-history-container" class="space-y-3 mt-3"></div>
                  </div>

                  <!-- Hidden ID storage -->
                  <input type="hidden" id="edit-id">
              </form>
          </div>

          <!-- Footer Actions -->
          <div class="p-6 border-t border-slate-100 bg-slate-50 rounded-b-2xl flex flex-wrap items-center gap-3">
              <!-- Save Changes -->
              <button onclick="saveCaseChanges()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors shadow-sm">
                  ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
              </button>
              
              <!-- Delete -->
              <button onclick="deleteCaseFromModal()" class="px-4 py-2 bg-rose-100 text-rose-600 hover:bg-rose-200 rounded-lg text-sm font-semibold transition-colors">
                  ‡∏•‡∏ö‡πÄ‡∏Ñ‡∏™
              </button>

              <!-- Toggle Status -->
              <button onclick="toggleStatusFromModal()" id="btn-toggle-status" class="px-4 py-2 bg-amber-100 text-amber-700 hover:bg-amber-200 rounded-lg text-sm font-semibold transition-colors">
                  ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
              </button>

              <!-- Close -->
              <button onclick="closeModalWithCheck()" class="px-4 py-2 bg-white border border-slate-300 text-slate-600 hover:bg-slate-50 rounded-lg text-sm font-semibold transition-colors">
                  ‡∏õ‡∏¥‡∏î
              </button>
          </div>
      </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="fixed bottom-6 right-6 transform translate-y-20 opacity-0 transition-all duration-300 z-[60]">
      <div class="bg-slate-800 text-white px-6 py-3 rounded-lg shadow-2xl flex items-center gap-3">
          <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
          <span id="toast-msg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>
      </div>
  </div>

  <script>
    // --- Mock Data & LocalStorage ---
    const DB_KEY = 'student_behavior_db';
    const LOGS_KEY = 'system_login_logs';
    const SESSIONS_KEY = 'active_sessions_mock';
    
    let casesData = JSON.parse(localStorage.getItem(DB_KEY)) || [];
    let systemLogs = JSON.parse(localStorage.getItem(LOGS_KEY)) || [];
    let activeSessions = JSON.parse(localStorage.getItem(SESSIONS_KEY)) || {};

    // --- State Management ---
    let currentUser = null;
    let originalCaseState = null; 
    let isSidebarOpen = true;
    let adminUpdateInterval = null; // Declare interval variable

    // --- Config Data ---
    const prefixes = ['‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢', '‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á', '‡∏ô‡∏≤‡∏¢', '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß'];
    const grades = ['‡∏°.1', '‡∏°.2', '‡∏°.3', '‡∏°.4', '‡∏°.5', '‡∏°.6'];

    // --- Gemini API Integration ---
    const apiKey = ""; // API Key injected by environment

    async function callGemini(prompt, type) {
        const loading = document.getElementById('ai-loading');
        loading.classList.remove('hidden');

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            });

            if (!response.ok) throw new Error('API Error');

            const data = await response.json();
            const text = data.candidates[0].content.parts[0].text;
            
            // Save to case history
            const caseId = Number(document.getElementById('edit-id').value);
            const caseIndex = casesData.findIndex(c => c.id === caseId);
            
            if (caseIndex !== -1) {
                const newResponse = {
                    id: Date.now(),
                    type: type,
                    content: text,
                    timestamp: new Date().toISOString()
                };
                
                if (!casesData[caseIndex].aiHistory) {
                    casesData[caseIndex].aiHistory = [];
                }
                casesData[caseIndex].aiHistory.push(newResponse);
                localStorage.setItem(DB_KEY, JSON.stringify(casesData));
                
                // Render update
                renderAIHistory(casesData[caseIndex].aiHistory);
            }

        } catch (error) {
            alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`);
        } finally {
            loading.classList.add('hidden');
        }
    }

    function renderAIHistory(history) {
        const container = document.getElementById('ai-history-container');
        container.innerHTML = '';

        if (!history || history.length === 0) return;

        // Sort new to old
        [...history].reverse().forEach(item => {
            const timeStr = new Date(item.timestamp).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', hour12: false });
            
            const card = document.createElement('div');
            card.id = `ai-response-${item.id}`;
            card.className = 'border border-indigo-100 rounded-lg overflow-hidden bg-white shadow-sm transition-all ai-card-collapsed';
            card.innerHTML = `
                <div class="bg-indigo-50/50 px-3 py-2 flex justify-between items-center cursor-pointer hover:bg-indigo-50 transition-colors" onclick="toggleAIResponse('${item.id}')">
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-bold text-indigo-700 bg-indigo-100 px-2 py-0.5 rounded">${item.type}</span>
                        <span class="text-[10px] text-slate-400 font-medium">${timeStr} ‡∏ô.</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="deleteAIResponse(event, ${item.id})" class="text-slate-400 hover:text-rose-500 transition-colors p-1" title="‡∏•‡∏ö">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                        <svg id="arrow-${item.id}" class="w-4 h-4 text-indigo-400 ai-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                </div>
                <div class="ai-card-content border-t border-indigo-50/50">
                    <div class="p-3 text-sm text-slate-700 whitespace-pre-wrap leading-relaxed">${item.content}</div>
                </div>
            `;
            container.appendChild(card);
            
            // Auto expand the first one (newest)
            if (container.children.length === 1) {
                setTimeout(() => toggleAIResponse(item.id), 50);
            }
        });
    }

    function toggleAIResponse(id) {
        const card = document.getElementById(`ai-response-${id}`);
        if (card) {
            card.classList.toggle('ai-card-collapsed');
        }
    }

    function deleteAIResponse(event, responseId) {
        event.stopPropagation();
        if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡∏à‡∏≤‡∏Å AI?')) return;

        const caseId = Number(document.getElementById('edit-id').value);
        const caseIndex = casesData.findIndex(c => c.id === caseId);

        if (caseIndex !== -1 && casesData[caseIndex].aiHistory) {
            casesData[caseIndex].aiHistory = casesData[caseIndex].aiHistory.filter(r => r.id !== responseId);
            localStorage.setItem(DB_KEY, JSON.stringify(casesData));
            renderAIHistory(casesData[caseIndex].aiHistory);
            showToast('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° AI ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        }
    }

    function getCaseInfoForAI() {
        const students = [];
        document.querySelectorAll('#edit-student-container .student-row').forEach(row => {
            const name = row.querySelector('.input-name').value;
            const grade = row.querySelector('.input-grade').value;
            if(name) students.push(`${name} (${grade})`);
        });

        const behavior = document.getElementById('edit-behavior').value;
        const subType = document.getElementById('edit-vice-type').value;
        const detail = document.getElementById('edit-detail').value;
        
        let behaviorText = behaviorLabels[behavior]?.label || behavior;
        if (behavior === 'vice' && subType) behaviorText += ` - ${subType}`;

        return `‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${students.join(', ')}\n‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°: ${behaviorText}\n‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${detail}`;
    }

    function generateAIAdvice() {
        const caseInfo = getCaseInfoForAI();
        const prompt = `‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏à‡∏¥‡∏ï‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏Ñ‡∏™‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:\n${caseInfo}\n\n‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤ 3 ‡∏Ç‡πâ‡∏≠ ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏ò‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤`;
        callGemini(prompt, '‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥');
    }

    function generateAILetter() {
        const caseInfo = getCaseInfoForAI();
        const prompt = `‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏∏‡∏£‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏£‡πà‡∏≤‡∏á‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏ä‡∏¥‡∏ç‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£ (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏¥‡∏ç‡∏°‡∏≤‡∏û‡∏π‡∏î‡∏Ñ‡∏∏‡∏¢‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:\n${caseInfo}\n\n‡πÇ‡∏ó‡∏ô‡∏Ç‡∏≠‡∏á‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢: ‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡∏£‡πà‡∏ß‡∏°‡∏°‡∏∑‡∏≠ ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£`;
        callGemini(prompt, '‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏ä‡∏¥‡∏ç');
    }

    // --- Utils ---
    const showToast = (msg) => {
        const toast = document.getElementById('toast');
        document.getElementById('toast-msg').textContent = msg;
        toast.classList.remove('translate-y-20', 'opacity-0');
        setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
    }

    const formatDate = (dateStr) => {
        if(!dateStr) return '-';
        const d = new Date(dateStr);
        return d.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' });
    }

    const formatDateTime = (dateStr) => {
        const d = new Date(dateStr);
        return d.toLocaleDateString('th-TH', { day: 'numeric', month: 'short' }) + ' ' + d.toLocaleTimeString('th-TH', { hour12: false });
    }

    // --- Helper Functions for Time Picker (Select Based) ---
    function populateTimeSelects() {
        const hours = Array.from({length: 24}, (_, i) => String(i).padStart(2, '0'));
        const minutes = Array.from({length: 60}, (_, i) => String(i).padStart(2, '0'));

        const createOptions = (arr) => arr.map(val => `<option value="${val}">${val}</option>`).join('');

        ['input', 'edit'].forEach(prefix => {
            const hSelect = document.getElementById(`${prefix}-time-hour`);
            const mSelect = document.getElementById(`${prefix}-time-minute`);
            if (hSelect && mSelect) {
                hSelect.innerHTML = createOptions(hours);
                mSelect.innerHTML = createOptions(minutes);
            }
        });
    }

    function setTimeSelects(prefix, timeStr) {
        // timeStr format HH:mm
        if (!timeStr) return;
        const [h, m] = timeStr.split(':');
        const hSelect = document.getElementById(`${prefix}-time-hour`);
        const mSelect = document.getElementById(`${prefix}-time-minute`);
        if (hSelect) hSelect.value = h;
        if (mSelect) mSelect.value = m;
    }

    function getTimeFromSelects(prefix) {
        const h = document.getElementById(`${prefix}-time-hour`).value;
        const m = document.getElementById(`${prefix}-time-minute`).value;
        return `${h}:${m}`;
    }

    // Helper for Thai Time (HH:mm)
    function getCurrentTime() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        return `${hours}:${minutes}`;
    }

    const behaviorLabels = {
        'fight': { label: '‡∏ó‡∏∞‡πÄ‡∏•‡∏≤‡∏∞‡∏ß‡∏¥‡∏ß‡∏≤‡∏ó', color: 'text-rose-600 bg-rose-50' },
        'skip': { label: '‡∏´‡∏ô‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', color: 'text-amber-600 bg-amber-50' },
        'vice': { label: '‡∏≠‡∏ö‡∏≤‡∏¢‡∏°‡∏∏‡∏Ç', color: 'text-slate-600 bg-slate-100' },
        'relationship': { label: '‡∏ä‡∏π‡πâ‡∏™‡∏≤‡∏ß', color: 'text-pink-600 bg-pink-50' }
    };

    // --- Sidebar Logic ---
    function toggleSidebar() {
        isSidebarOpen = !isSidebarOpen;
        const sidebar = document.getElementById('main-sidebar');
        const bottomIcon = document.getElementById('sidebar-toggle-icon-bottom');
        const headerIcon = document.getElementById('sidebar-toggle-icon');
        
        if (isSidebarOpen) {
            sidebar.classList.remove('w-20', 'sidebar-collapsed');
            sidebar.classList.add('w-72');
            bottomIcon.classList.add('rotate-180'); 
            if(headerIcon) headerIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>';
        } else {
            sidebar.classList.remove('w-72');
            sidebar.classList.add('w-20', 'sidebar-collapsed');
            bottomIcon.classList.remove('rotate-180'); 
            if(headerIcon) headerIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path>';
        }
    }

    // --- Realtime Clock ---
    function updateRealTime() {
        const now = new Date();
        const datePart = now.toLocaleDateString('th-TH', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        const timePart = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
        
        document.getElementById('realtime-clock').textContent = `${datePart} ‡πÄ‡∏ß‡∏•‡∏≤ ${timePart} ‡∏ô.`;

        const month = now.getMonth() + 1;
        const year = now.getFullYear();
        let term = 1;
        let academicYear = year + 543;

        if (month >= 5 && month <= 10) {
            term = 1;
        } else {
            term = 2;
            if (month >= 1 && month <= 4) {
                academicYear = (year - 1) + 543;
            }
        }
        
        const academicInfo = document.getElementById('academic-info');
        if(academicInfo) {
            academicInfo.textContent = `‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà ${term} ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ${academicYear}`;
        }
    }
    setInterval(updateRealTime, 1000);
    updateRealTime();

    // --- Logger ---
    function logAction(user, action) {
        const entry = {
            id: Date.now(),
            timestamp: new Date().toISOString(),
            user: user,
            action: action,
            device: navigator.platform
        };
        systemLogs.unshift(entry); 
        if(systemLogs.length > 100) systemLogs.pop();
        localStorage.setItem(LOGS_KEY, JSON.stringify(systemLogs));
    }

    function updateSession(user, isActive) {
        if(isActive) {
            activeSessions[user] = new Date().toISOString();
        } else {
            delete activeSessions[user];
        }
        localStorage.setItem(SESSIONS_KEY, JSON.stringify(activeSessions));
    }

    // --- Dynamic Student Rows Logic ---
    function createStudentRowHTML(index) {
        // Generate Prefix Options
        const prefixOptions = prefixes.map(p => `<option value="${p}">${p}</option>`).join('');
        const gradeOptions = grades.map(g => `<option value="${g}">${g}</option>`).join('');

        return `
        <div class="student-row grid grid-cols-1 md:grid-cols-12 gap-3 p-3 border border-slate-200 rounded-lg bg-white relative animate-[fadeInUp_0.2s_ease-out]">
            ${index > 0 ? `<button type="button" onclick="this.parentElement.remove()" class="absolute -top-2 -right-2 bg-rose-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs shadow hover:bg-rose-600">√ó</button>` : ''}
            
            <div class="md:col-span-2">
                <label class="block text-[10px] text-slate-500 uppercase font-bold mb-1">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</label>
                <select class="input-prefix form-input w-full px-2 py-2 border border-slate-200 rounded-lg text-sm bg-white">
                    ${prefixOptions}
                </select>
            </div>
            <div class="md:col-span-5">
                <label class="block text-[10px] text-slate-500 uppercase font-bold mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</label>
                <input type="text" class="input-name form-input w-full px-2 py-2 border border-slate-200 rounded-lg text-sm" placeholder="‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
            </div>
            <div class="md:col-span-3">
                <label class="block text-[10px] text-slate-500 uppercase font-bold mb-1">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</label>
                <select class="input-grade form-input w-full px-2 py-2 border border-slate-200 rounded-lg text-sm bg-white">
                    ${gradeOptions}
                </select>
            </div>
            <div class="md:col-span-2">
                <label class="block text-[10px] text-slate-500 uppercase font-bold mb-1">‡∏´‡πâ‡∏≠‡∏á</label>
                <input type="text" class="input-room form-input w-full px-2 py-2 border border-slate-200 rounded-lg text-sm text-center" placeholder="1">
            </div>
        </div>`;
    }

    function addStudentRow(containerId = 'student-container') {
        const container = document.getElementById(containerId);
        const index = container.children.length;
        container.insertAdjacentHTML('beforeend', createStudentRowHTML(index));
    }

    // --- Behavior Sub-category Logic ---
    function toggleViceOptions() {
        const viceRadio = document.querySelector('input[name="behavior"][value="vice"]');
        const container = document.getElementById('vice-sub-options');
        const select = document.getElementById('input-vice-type');
        
        if (viceRadio.checked) {
            container.classList.remove('hidden');
            select.setAttribute('required', 'true');
        } else {
            container.classList.add('hidden');
            select.removeAttribute('required');
            select.value = ""; // Reset
        }
    }

    function toggleViceOptionsEdit() {
        const behavior = document.getElementById('edit-behavior').value;
        const container = document.getElementById('edit-vice-sub-options');
        
        if (behavior === 'vice') {
            container.classList.remove('hidden');
        } else {
            container.classList.add('hidden');
            document.getElementById('edit-vice-type').value = "";
        }
    }

    // --- Login Logic ---
    function handleLogin(e) {
        e.preventDefault();
        const user = document.getElementById('username').value;
        const pass = document.getElementById('password').value;

        if(pass === '1234' && user.trim() !== '') {
            currentUser = user;
            logAction(user, '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö (Login)');
            updateSession(user, true);

            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('dashboard-layout').classList.remove('hidden');
            document.getElementById('display-name').textContent = user === 'admin' ? 'Admin Teacher' : user;
            document.getElementById('display-role').textContent = user === 'admin' ? '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î' : '‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤';
            document.getElementById('user-avatar').textContent = user.substring(0,2).toUpperCase();

            if(user === 'admin') {
                document.getElementById('admin-menu-section').classList.remove('hidden');
            } else {
                document.getElementById('admin-menu-section').classList.add('hidden');
            }

            initDashboard();
        } else {
            document.getElementById('login-error').classList.remove('hidden');
        }
    }

    function handleLogout() {
        if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?')) {
            if(currentUser) {
                logAction(currentUser, '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (Logout)');
                updateSession(currentUser, false);
            }
            currentUser = null;
            document.getElementById('dashboard-layout').classList.add('hidden');
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('login-error').classList.add('hidden');
        }
    }

    // --- Navigation ---
    function switchPage(pageId) {
        ['view-dashboard', 'view-record', 'view-cases', 'view-admin'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.classList.add('hidden');
        });
        
        ['nav-dashboard', 'nav-record', 'nav-cases', 'nav-admin'].forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                el.classList.remove('active', 'bg-white/10', 'border-l-4');
                el.classList.add('hover:bg-slate-800/50');
            }
        });

        if(adminUpdateInterval) clearInterval(adminUpdateInterval);

        document.getElementById(`view-${pageId}`).classList.remove('hidden');
        
        const activeNav = document.getElementById(`nav-${pageId}`);
        if(activeNav) {
            activeNav.classList.add('active');
            activeNav.classList.remove('hover:bg-slate-800/50');
        }

        const titles = {
            'dashboard': '‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•',
            'record': '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà',
            'cases': '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥',
            'admin': '‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Admin Monitor)'
        };
        document.getElementById('page-title').textContent = titles[pageId];

        // Refresh Data on Page Switch for consistency
        casesData = JSON.parse(localStorage.getItem(DB_KEY)) || [];
        systemLogs = JSON.parse(localStorage.getItem(LOGS_KEY)) || [];
        activeSessions = JSON.parse(localStorage.getItem(SESSIONS_KEY)) || {};

        if(pageId === 'dashboard') updateStats();
        if(pageId === 'cases') renderTable();
        if(pageId === 'admin') {
            renderAdminPanel();
            adminUpdateInterval = setInterval(renderAdminPanel, 3000); 
        }
    }

    function renderAdminPanel() {
        // Refresh data inside the loop to ensure real-time updates
        activeSessions = JSON.parse(localStorage.getItem(SESSIONS_KEY)) || {};
        systemLogs = JSON.parse(localStorage.getItem(LOGS_KEY)) || [];

        const sessionContainer = document.getElementById('active-sessions-list');
        const users = Object.keys(activeSessions);
        
        if(users.length === 0) {
            sessionContainer.innerHTML = '<div class="col-span-4 text-center text-slate-400 py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</div>';
        } else {
            sessionContainer.innerHTML = users.map(u => `
                <div class="flex items-center gap-3 p-4 bg-slate-50 border border-slate-200 rounded-xl">
                    <div class="w-10 h-10 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center font-bold">
                        ${u.substring(0,2).toUpperCase()}
                    </div>
                    <div>
                        <p class="font-bold text-slate-700">${u}</p>
                        <p class="text-xs text-emerald-600 flex items-center gap-1">
                            <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full"></span> ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
                        </p>
                    </div>
                </div>
            `).join('');
        }

        const logTbody = document.getElementById('logs-tbody');
        logTbody.innerHTML = systemLogs.map(log => {
            const isLogin = log.action.includes('Login');
            return `
                <tr class="border-b border-slate-100 hover:bg-slate-50">
                    <td class="px-6 py-3 text-slate-500 font-mono text-xs">${formatDateTime(log.timestamp)}</td>
                    <td class="px-6 py-3 font-medium text-slate-700">${log.user}</td>
                    <td class="px-6 py-3">
                        <span class="px-2 py-1 rounded text-xs font-bold ${isLogin ? 'bg-indigo-100 text-indigo-700' : 'bg-slate-100 text-slate-600'}">
                            ${log.action}
                        </span>
                    </td>
                    <td class="px-6 py-3 text-slate-400 text-xs">${log.device}</td>
                </tr>
            `;
        }).join('');
    }

    // --- Form Handling (Create) ---
    function handleRecordSubmit(e) {
        e.preventDefault();
        
        // 1. Get Behavior & Sub-category
        const behaviors = document.getElementsByName('behavior');
        let selectedBehavior = '';
        for(let b of behaviors) if(b.checked) selectedBehavior = b.value;
        
        let viceDetail = '';
        if(selectedBehavior === 'vice') {
            viceDetail = document.getElementById('input-vice-type').value;
        }

        // 2. Gather Students Data
        const studentRows = document.querySelectorAll('#student-container .student-row');
        const studentsList = [];
        
        studentRows.forEach(row => {
            const prefix = row.querySelector('.input-prefix').value;
            const name = row.querySelector('.input-name').value.trim();
            const grade = row.querySelector('.input-grade').value;
            const room = row.querySelector('.input-room').value.trim();
            
            if(name) { // Only add if name is not empty
                studentsList.push({
                    prefix: prefix,
                    name: name,
                    grade: grade,
                    room: room
                });
            }
        });

        if(studentsList.length === 0) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô');
            return;
        }

        const newCase = {
            id: Date.now(),
            date: document.getElementById('input-date').value,
            time: getTimeFromSelects('input'), // Use Dropdown Time
            students: studentsList, 
            behavior: selectedBehavior,
            viceDetail: viceDetail,
            detail: document.getElementById('input-detail').value,
            status: 'pending', 
            timestamp: new Date().toISOString()
        };

        casesData.unshift(newCase);
        localStorage.setItem(DB_KEY, JSON.stringify(casesData));
        
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        resetForm();
    }

    function resetForm() {
        document.getElementById('record-form').reset();
        document.getElementById('input-date').valueAsDate = new Date();
        setTimeSelects('input', getCurrentTime()); // Reset Dropdown Time
        document.getElementById('student-container').innerHTML = '';
        addStudentRow(); // Add initial row
        toggleViceOptions();
    }

    // --- Dashboard Stats ---
    function updateStats() {
        const total = casesData.length;
        const pending = casesData.filter(c => c.status === 'pending').length;
        const resolved = casesData.filter(c => c.status === 'resolved').length;

        document.getElementById('stat-total').innerText = total;
        document.getElementById('stat-pending').innerText = pending;
        document.getElementById('stat-resolved').innerText = resolved;

        const behaviorCounts = {};
        Object.keys(behaviorLabels).forEach(k => behaviorCounts[k] = 0);
        casesData.forEach(c => {
            if(behaviorCounts[c.behavior] !== undefined) behaviorCounts[c.behavior]++;
            else behaviorCounts[c.behavior] = 1; 
        });

        // Count grades from all students in all cases
        const allGrades = ['‡∏°.1', '‡∏°.2', '‡∏°.3', '‡∏°.4', '‡∏°.5', '‡∏°.6'];
        const gradeCounts = {};
        allGrades.forEach(g => gradeCounts[g] = 0);
        
        casesData.forEach(c => {
            // Support legacy single student data
            if (c.students && Array.isArray(c.students)) {
                c.students.forEach(s => {
                    if(gradeCounts[s.grade] !== undefined) gradeCounts[s.grade]++;
                });
            } else if (c.grade) {
                if(gradeCounts[c.grade] !== undefined) gradeCounts[c.grade]++;
            }
        });

        renderSimpleChart('chart-behavior', behaviorCounts, behaviorLabels);
        renderSimpleChart('chart-grade', gradeCounts);
    }

    function renderSimpleChart(containerId, data, labelsMap = null) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        const total = Object.values(data).reduce((a,b)=>a+b, 0);

        Object.entries(data).forEach(([key, value]) => {
            const percentage = total === 0 ? 0 : (value / total) * 100;
            let label = key;
            let colorClass = 'bg-indigo-500';

            if(labelsMap && labelsMap[key]) {
                label = labelsMap[key].label;
                if(key === 'fight') colorClass = 'bg-rose-500';
                if(key === 'skip') colorClass = 'bg-amber-500';
                if(key === 'relationship') colorClass = 'bg-pink-500';
                if(key === 'vice') colorClass = 'bg-slate-500';
            } else {
                if(key.includes('1')) colorClass = 'bg-blue-400';
                if(key.includes('2')) colorClass = 'bg-blue-500';
                if(key.includes('3')) colorClass = 'bg-blue-600';
                if(key.includes('4')) colorClass = 'bg-purple-400';
                if(key.includes('5')) colorClass = 'bg-purple-500';
                if(key.includes('6')) colorClass = 'bg-purple-600';
            }

            container.innerHTML += `
                <div class="flex items-center gap-3 text-sm">
                    <div class="w-20 font-medium text-slate-600 truncate">${label}</div>
                    <div class="flex-1 h-2.5 bg-slate-100 rounded-full overflow-hidden">
                        <div class="h-full ${colorClass} rounded-full" style="width: ${percentage}%"></div>
                    </div>
                    <div class="w-8 text-right text-slate-500">${value}</div>
                </div>
            `;
        });
    }

    // --- Table Rendering ---
    function renderTable() {
        const tbody = document.getElementById('cases-tbody');
        const statusFilter = document.getElementById('filter-status').value;
        const gradeFilter = document.getElementById('filter-grade').value;
        
        let filteredData = casesData;
        
        if(statusFilter !== 'all') {
            filteredData = filteredData.filter(c => c.status === statusFilter);
        }
        if(gradeFilter !== 'all') {
            // For multi-student cases, match if ANY student is in the grade
            filteredData = filteredData.filter(c => {
                if (c.students && Array.isArray(c.students)) {
                    return c.students.some(s => s.grade === gradeFilter);
                }
                return c.grade === gradeFilter; // Legacy
            });
        }

        if(filteredData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-slate-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</td></tr>';
            return;
        }

        tbody.innerHTML = filteredData.map(c => {
            let bInfo = behaviorLabels[c.behavior] || { label: c.behavior, color: 'text-gray-600 bg-gray-100' };
            
            // Append Vice sub-type if exists
            let behaviorText = bInfo.label;
            if (c.behavior === 'vice' && c.viceDetail) {
                behaviorText += ` (${c.viceDetail})`;
            }

            const statusBadge = c.status === 'resolved' 
                ? '<span class="px-2.5 py-1 rounded-full text-xs font-bold bg-emerald-100 text-emerald-700">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß</span>'
                : '<span class="px-2.5 py-1 rounded-full text-xs font-bold bg-amber-100 text-amber-700">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</span>';

            // Handle Students Display
            let studentsDisplay = '';
            let gradesDisplay = '';
            
            if (c.students && Array.isArray(c.students)) {
                if (c.students.length === 1) {
                    const s = c.students[0];
                    studentsDisplay = `${s.prefix}${s.name}`;
                    gradesDisplay = `${s.grade}/${s.room}`;
                } else {
                    studentsDisplay = `${c.students[0].prefix}${c.students[0].name} ‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${c.students.length - 1} ‡∏Ñ‡∏ô`;
                    gradesDisplay = `‡∏Ñ‡∏•‡∏∞‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô`; // Or list distinct grades
                }
            } else {
                // Legacy
                studentsDisplay = c.name;
                gradesDisplay = `${c.grade}/${c.room}`;
            }

            return `
                <tr class="hover:bg-slate-50 transition-colors border-b border-slate-100 last:border-0">
                    <td class="px-6 py-4 whitespace-nowrap text-slate-500">${formatDate(c.date)}</td>
                    <td class="px-6 py-4 font-medium text-slate-800" title="${getStudentListTooltip(c)}">${studentsDisplay}</td>
                    <td class="px-6 py-4 text-slate-600">${gradesDisplay}</td>
                    <td class="px-6 py-4">
                        <span class="px-2.5 py-1 rounded-md text-xs font-bold ${bInfo.color}">${behaviorText}</span>
                    </td>
                    <td class="px-6 py-4">${statusBadge}</td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="openCaseModal(${c.id})" class="text-sm font-medium text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-lg hover:bg-indigo-100 transition-colors">
                            ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function getStudentListTooltip(c) {
        if (c.students && Array.isArray(c.students)) {
            return c.students.map(s => `${s.prefix}${s.name} (${s.grade}/${s.room})`).join('\n');
        }
        return c.name;
    }

    // --- MODAL & EDIT ACTIONS ---
    function openCaseModal(id) {
        const c = casesData.find(x => x.id === id);
        if(!c) return;

        // Populate Basic
        document.getElementById('edit-id').value = c.id;
        document.getElementById('edit-date').value = c.date;
        setTimeSelects('edit', c.time); // Set Dropdown Time in Modal
        document.getElementById('edit-behavior').value = c.behavior;
        document.getElementById('edit-detail').value = c.detail;
        
        // Handle Vice Sub-option
        toggleViceOptionsEdit();
        if(c.behavior === 'vice' && c.viceDetail) {
            document.getElementById('edit-vice-type').value = c.viceDetail;
        }

        // Populate Students
        const container = document.getElementById('edit-student-container');
        container.innerHTML = ''; // Clear previous
        
        if (c.students && Array.isArray(c.students)) {
            c.students.forEach(s => {
                const rowHTML = createStudentRowHTML(container.children.length);
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = rowHTML;
                const row = tempDiv.firstElementChild;
                
                row.querySelector('.input-prefix').value = s.prefix;
                row.querySelector('.input-name').value = s.name;
                row.querySelector('.input-grade').value = s.grade;
                row.querySelector('.input-room').value = s.room;
                
                container.appendChild(row);
            });
        } else {
            // Legacy Support (Convert old single data to row)
            const rowHTML = createStudentRowHTML(0);
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = rowHTML;
            const row = tempDiv.firstElementChild;
            // Legacy didn't have prefix, default to select options
            row.querySelector('.input-name').value = c.name;
            row.querySelector('.input-grade').value = c.grade;
            row.querySelector('.input-room').value = c.room;
            container.appendChild(row);
        }

        // Render AI History
        renderAIHistory(c.aiHistory);

        // Update Button Status Text
        const btnToggle = document.getElementById('btn-toggle-status');
        if(c.status === 'resolved') {
            btnToggle.textContent = '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô: ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
            btnToggle.className = 'px-4 py-2 bg-amber-100 text-amber-700 hover:bg-amber-200 rounded-lg text-sm font-semibold transition-colors';
        } else {
            btnToggle.textContent = '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô: ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';
            btnToggle.className = 'px-4 py-2 bg-emerald-100 text-emerald-700 hover:bg-emerald-200 rounded-lg text-sm font-semibold transition-colors';
        }

        originalCaseState = JSON.stringify(getCurrentModalData()); // Capture exact state for comparison

        const backdrop = document.getElementById('modal-backdrop');
        const content = document.getElementById('modal-content');
        backdrop.classList.remove('hidden');
        setTimeout(() => {
            content.classList.remove('scale-95', 'opacity-0');
            content.classList.add('scale-100', 'opacity-100');
        }, 10);
    }

    function closeModal() {
        const backdrop = document.getElementById('modal-backdrop');
        const content = document.getElementById('modal-content');
        
        content.classList.remove('scale-100', 'opacity-100');
        content.classList.add('scale-95', 'opacity-0');
        
        setTimeout(() => {
            backdrop.classList.add('hidden');
            originalCaseState = null;
        }, 200);
    }

    function getCurrentModalData() {
        const id = Number(document.getElementById('edit-id').value);
        const currentDB = casesData.find(x => x.id === id);
        
        // Gather Students
        const studentRows = document.querySelectorAll('#edit-student-container .student-row');
        const studentsList = [];
        studentRows.forEach(row => {
            studentsList.push({
                prefix: row.querySelector('.input-prefix').value,
                name: row.querySelector('.input-name').value.trim(),
                grade: row.querySelector('.input-grade').value,
                room: row.querySelector('.input-room').value.trim()
            });
        });

        // Gather Vice Detail
        const behavior = document.getElementById('edit-behavior').value;
        const viceDetail = (behavior === 'vice') ? document.getElementById('edit-vice-type').value : '';

        return {
            id: id,
            date: document.getElementById('edit-date').value,
            time: getTimeFromSelects('edit'), // Get time from edit selects
            students: studentsList,
            behavior: behavior,
            viceDetail: viceDetail,
            detail: document.getElementById('edit-detail').value,
            status: currentDB ? currentDB.status : 'pending',
            timestamp: currentDB ? currentDB.timestamp : new Date().toISOString()
        };
    }

    function closeModalWithCheck() {
        if(!originalCaseState) { closeModal(); return; }

        const currentData = getCurrentModalData();
        // Remove aiHistory from comparison logic since it's saved independently
        const originalData = JSON.parse(originalCaseState);

        if(JSON.stringify(currentData) !== JSON.stringify(originalData)) {
            if(confirm('‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏¥‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                saveCaseChanges();
            } else {
                closeModal();
            }
        } else {
            closeModal();
        }
    }

    function saveCaseChanges() {
        const newData = getCurrentModalData();
        const index = casesData.findIndex(x => x.id === newData.id);
        
        if(index !== -1) {
            // Preserve AI history when saving basic details
            newData.aiHistory = casesData[index].aiHistory;
            casesData[index] = newData;
            localStorage.setItem(DB_KEY, JSON.stringify(casesData));
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            renderTable(); 
            originalCaseState = JSON.stringify(newData); 
        }
    }

    function deleteCaseFromModal() {
        if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ‡∏ñ‡∏≤‡∏ß‡∏£?')) {
            const id = Number(document.getElementById('edit-id').value);
            casesData = casesData.filter(x => x.id !== id);
            localStorage.setItem(DB_KEY, JSON.stringify(casesData));
            showToast('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            renderTable();
            originalCaseState = null; 
            closeModal();
        }
    }

    function toggleStatusFromModal() {
        const id = Number(document.getElementById('edit-id').value);
        const index = casesData.findIndex(x => x.id === id);
        
        if(index !== -1) {
            const newStatus = casesData[index].status === 'resolved' ? 'pending' : 'resolved';
            casesData[index].status = newStatus;
            
            localStorage.setItem(DB_KEY, JSON.stringify(casesData));
            
            const btnToggle = document.getElementById('btn-toggle-status');
            if(newStatus === 'resolved') {
                btnToggle.textContent = '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô: ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
                btnToggle.className = 'px-4 py-2 bg-amber-100 text-amber-700 hover:bg-amber-200 rounded-lg text-sm font-semibold transition-colors';
            } else {
                btnToggle.textContent = '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô: ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';
                btnToggle.className = 'px-4 py-2 bg-emerald-100 text-emerald-700 hover:bg-emerald-200 rounded-lg text-sm font-semibold transition-colors';
            }

            // Update in modal tracking
            const currentModalData = getCurrentModalData();
            currentModalData.status = newStatus;
            
            showToast(`‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ${newStatus === 'resolved' ? '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' : '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'}`);
            renderTable();
        }
    }

    function initDashboard() {
        populateTimeSelects(); // Initialize Select Options
        document.getElementById('input-date').valueAsDate = new Date();
        setTimeSelects('input', getCurrentTime()); // Set Default Time using custom select
        
        // Init form with 1 row
        if(document.getElementById('student-container').children.length === 0) {
            addStudentRow();
        }
        updateStats();
    }
  </script>
</body>
</html>
